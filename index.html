<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Kellerbar" />
  <meta name="theme-color" content="#0a0a0f" />
  <title>Kellerbar Kassa</title>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KELLERBAR KASSA â€” styles
   Industrial-minimal dark tap-app aesthetic
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

:root {
  --bg:         #0a0a0f;
  --bg2:        #13131c;
  --bg3:        #1c1c2a;
  --border:     #2a2a3d;
  --accent:     #f5c842;
  --green:      #3ddc84;
  --red:        #ff5f57;
  --text:       #f0f0f5;
  --text-muted: #7a7a9a;
  --radius:     16px;
  --radius-sm:  10px;
  --tab-h:      72px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

@media (prefers-color-scheme: light) {
  :root {
    --bg:         #f5f5f0;
    --bg2:        #ffffff;
    --bg3:        #ebebeb;
    --border:     #d0d0d0;
    --text:       #111118;
    --text-muted: #888898;
  }
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: -apple-system, 'SF Pro Display', 'Helvetica Neue', sans-serif;
  -webkit-font-smoothing: antialiased;
  overscroll-behavior: none;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

#app {
  display: flex;
  flex-direction: column;
  height: 100dvh;
  max-width: 480px;
  margin: 0 auto;
  position: relative;
}

/* â”€â”€ TAB BAR â€” Classic â”€â”€ */
.tabbar {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 480px;
  height: calc(var(--tab-h) + var(--safe-bottom));
  padding-bottom: var(--safe-bottom);
  background: var(--bg2);
  border-top: 1px solid var(--border);
  display: flex;
  z-index: 100;
}

.tab {
  flex: 1;
  background: none;
  border: none;
  color: var(--text-muted);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 3px;
  cursor: pointer;
  transition: color .2s;
  padding-bottom: 4px;
  -webkit-tap-highlight-color: transparent;
}
.tab.active { color: var(--accent); }
.tab:active { opacity: .7; }
.tab-icon  { font-size: 22px; }
.tab-label { font-size: 10px; font-weight: 600; letter-spacing: .5px; text-transform: uppercase; }

/* â”€â”€ TAB CONTENT â”€â”€ */
.tab-content {
  display: none;
  flex: 1;
  overflow-y: auto;
  padding: 16px 16px calc(var(--tab-h) + var(--safe-bottom) + 16px);
  -webkit-overflow-scrolling: touch;
}
.tab-content.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEMES â€” each with its own identity
   Not just color filters â€” full personality
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Extra theme variables used in surface treatments */
:root {
  --card-bg:      var(--bg2);
  --card-border:  var(--border);
  --card-shadow:  none;
  --body-bg:      var(--bg);
  --accent-glow:  none;
  --btn-primary-bg: var(--accent);
  --btn-primary-color: #000;
  --surface-radius: 16px;
}

/* â”€â”€ LIGHT â€” Clean, airy, minimal â”€â”€ */
body[data-theme="light"] {
  --bg:         #f0f0f5;
  --bg2:        #ffffff;
  --bg3:        #f5f5fa;
  --border:     #e0e0e8;
  --accent:     #3b82f6;
  --green:      #16a34a;
  --red:        #dc2626;
  --text:       #18181b;
  --text-muted: #909099;
  --card-bg:    #ffffff;
  --card-border: #e4e4ec;
  --card-shadow: 0 2px 12px rgba(0,0,0,0.06), 0 1px 0 rgba(255,255,255,0.9) inset;
  --accent-glow: 0 0 16px rgba(59,130,246,0.15);
  --body-bg:    linear-gradient(160deg, #f8f8ff 0%, #ececf5 100%);
  --btn-primary-bg: linear-gradient(135deg, #3b82f6, #1d4ed8);
  --btn-primary-color: #fff;
  --surface-radius: 12px;
}

/* â”€â”€ ICE theme removed â”€â”€ */

/* â”€â”€ CUSTOM â€” User-defined colors â”€â”€ */
body[data-theme="custom"] {
  --bg:         var(--custom-bg,       #0a0a0f);
  --bg2:        var(--custom-bg2,      #13131c);
  --bg3:        var(--custom-bg3,      #1c1c2a);
  --border:     var(--custom-border,   #2a2a3d);
  --accent:     var(--custom-accent,   #f5c842);
  --text:       var(--custom-text,     #f0f0f5);
  --text-muted: var(--custom-muted,    #7a7a9a);
  --card-bg:    var(--custom-card-bg,  #13131c);
  --card-border:var(--custom-border,   #2a2a3d);
  --card-shadow:var(--custom-shadow,   none);
  --accent-glow:var(--custom-glow,     none);
  --body-bg:    var(--custom-body-bg,  #0a0a0f);
  --btn-primary-bg: var(--custom-accent, #f5c842);
  --btn-primary-color: var(--custom-btn-text, #000);
  --surface-radius: 16px;
}

/* Custom picker UI */
.custom-picker-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.custom-picker-row:last-child { border-bottom: none; }
.custom-picker-label {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
}
.custom-picker-label small {
  display: block;
  font-size: 11px;
  color: var(--text-muted);
  font-weight: 400;
  margin-top: 1px;
}
.color-input-wrap {
  position: relative;
  width: 44px; height: 44px;
}
.color-input-wrap input[type="color"] {
  position: absolute;
  inset: 0;
  width: 100%; height: 100%;
  opacity: 0;
  cursor: pointer;
  border: none;
  padding: 0;
}
.color-swatch-display {
  width: 44px; height: 44px;
  border-radius: 50%;
  border: 2px solid var(--border);
  pointer-events: none;
  transition: border-color .2s;
  box-shadow: 0 2px 8px rgba(0,0,0,.3);
}
.color-input-wrap:hover .color-swatch-display,
.color-input-wrap:focus-within .color-swatch-display {
  border-color: var(--accent);
}


/* â”€â”€ Surface treatments applied via variables â”€â”€ */
body[data-theme] { background: var(--body-bg); }

/* Cards use theme-aware gradient backgrounds */
body[data-theme] .balance-card,
body[data-theme] .settings-section,
body[data-theme] .history-item,
body[data-theme] .drink-btn,
body[data-theme] .person-btn,
body[data-theme] .modal {
  background: var(--card-bg);
  border-color: var(--card-border);
  box-shadow: var(--card-shadow);
  border-radius: var(--surface-radius);
}

/* Accent button uses theme gradient */
body[data-theme] .btn-primary {
  background: var(--btn-primary-bg);
  color: var(--btn-primary-color);
}

/* Balance amount gets a glow in themed modes */
body[data-theme] .balance-amount {
  text-shadow: var(--accent-glow);
}

/* Person button border glow */
body[data-theme] .person-btn {
  border-color: var(--accent);
  box-shadow: var(--accent-glow);
}

/* Accent drink prices and amounts get glow */
body[data-theme] .drink-btn:active {
  border-color: var(--accent);
  box-shadow: var(--accent-glow);
}

/* Tabbar picks up theme surface */
body[data-theme] .tabbar {
  background: var(--card-bg);
  border-top-color: var(--card-border);
}

/* â”€â”€ DESIGN PICKER MODAL â”€â”€ */
.theme-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}
.theme-btn {
  border-radius: 14px;
  border: 2px solid rgba(255,255,255,0.08);
  padding: 16px 10px 14px;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  transition: border-color .15s, transform .12s;
  position: relative;
  overflow: hidden;
  min-height: 90px;
}
.theme-btn:active { transform: scale(.95); }
.theme-btn.active-theme {
  border-color: rgba(255,255,255,0.55);
  box-shadow: 0 0 0 1px rgba(255,255,255,0.2);
}
.theme-btn.active-theme::after {
  content: 'âœ“';
  position: absolute;
  top: 7px; right: 10px;
  font-size: 12px;
  font-weight: 900;
  color: white;
  text-shadow: 0 1px 4px rgba(0,0,0,.6);
}
.theme-dots {
  display: flex;
  gap: 5px;
  align-items: center;
}
.theme-dot {
  width: 12px; height: 12px;
  border-radius: 50%;
  border: 1.5px solid rgba(255,255,255,.25);
}
.theme-name {
  font-size: 11px;
  font-weight: 800;
  letter-spacing: .8px;
  text-transform: uppercase;
  color: rgba(255,255,255,0.9);
  text-shadow: 0 1px 4px rgba(0,0,0,.7);
}

/* â”€â”€ BALANCE CARD â”€â”€ */
.balance-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px 20px 20px;
  margin-bottom: 20px;
  text-align: center;
}
.balance-label {
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 8px;
}
.balance-amount {
  font-size: 52px;
  font-weight: 800;
  letter-spacing: -2px;
  color: var(--accent);
  line-height: 1;
  margin-bottom: 12px;
}
.balance-sub {
  display: flex;
  justify-content: center;
  gap: 24px;
  font-size: 14px;
  font-weight: 600;
}
.income-sum  { color: var(--green); }
.expense-sum { color: var(--red); }

/* â”€â”€ SECTION LABEL â”€â”€ */
.section-label {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin: 0 0 8px 2px;
}

/* â”€â”€ PERSON BUTTON â”€â”€ */
.person-btn {
  width: 100%;
  background: var(--bg2);
  border: 2px solid var(--accent);
  border-radius: var(--radius);
  color: var(--text);
  font-size: 18px;
  font-weight: 700;
  padding: 18px 20px;
  text-align: center;
  cursor: pointer;
  margin-bottom: 20px;
  transition: background .15s, transform .1s;
  -webkit-tap-highlight-color: transparent;
}
.person-btn:active { background: var(--bg3); transform: scale(.98); }

/* â”€â”€ DRINKS GRID â”€â”€ */
.drinks-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 16px;
}

.drink-btn {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  padding: 18px 12px;
  cursor: pointer;
  text-align: center;
  transition: border-color .15s, transform .1s, background .15s;
  min-height: 80px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
}
.drink-btn:active { transform: scale(.95); background: var(--bg3); border-color: var(--accent); }
.drink-btn-name  { font-size: 16px; font-weight: 700; }
.drink-btn-price { font-size: 13px; color: var(--accent); font-weight: 600; }

/* â”€â”€ ACTION ROW â”€â”€ */
.action-row {
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 10px;
  margin-top: 6px;
}

.btn-expense {
  background: var(--red);
  border: none;
  border-radius: var(--radius);
  color: #fff;
  font-size: 17px;
  font-weight: 700;
  padding: 18px 20px;
  cursor: pointer;
  transition: opacity .15s, transform .1s;
}
.btn-expense:active { opacity: .8; transform: scale(.97); }

.btn-undo {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text-muted);
  font-size: 15px;
  font-weight: 600;
  padding: 18px 18px;
  cursor: pointer;
  white-space: nowrap;
  transition: background .15s, transform .1s;
}
.btn-undo:active { background: var(--bg2); transform: scale(.97); }

/* â”€â”€ HISTORY â”€â”€ */
.history-filters {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 14px;
}
.filter-row { display: flex; gap: 8px; }
.filter-btn {
  flex: 1;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-muted);
  font-size: 13px;
  font-weight: 600;
  padding: 10px 4px;
  cursor: pointer;
  transition: all .15s;
}
.filter-btn.active { background: var(--accent); border-color: var(--accent); color: #000; }
.filter-select, .filter-input {
  flex: 1;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 14px;
  padding: 10px 12px;
  outline: none;
  -webkit-appearance: none;
}
.filter-input::placeholder { color: var(--text-muted); }

.history-list { display: flex; flex-direction: column; gap: 8px; }

.history-item-desc { font-size: 15px; font-weight: 600; }
.history-item-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
.history-item-amount { font-size: 18px; font-weight: 800; }
.history-item-amount.pos { color: var(--green); }
.history-item-amount.neg { color: var(--red); }
.history-empty { text-align: center; color: var(--text-muted); font-size: 15px; padding: 40px 0; }

/* â”€â”€ SETTINGS â”€â”€ */
.settings-section {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 14px;
}
.settings-title {
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text-muted);
  margin-bottom: 12px;
}
.drinks-settings-list, .persons-settings-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 12px;
}
.settings-item {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--bg3);
  border-radius: var(--radius-sm);
  padding: 12px 14px;
}
.settings-item-name  { flex: 1; font-size: 15px; font-weight: 600; }
.settings-item-price { font-size: 13px; color: var(--accent); font-weight: 600; margin-right: 4px; }
.settings-item-btn {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  padding: 4px 6px;
  border-radius: 8px;
  transition: background .15s;
}
.settings-item-btn:active { background: var(--border); }

.btn-add-drink {
  width: 100%;
  background: var(--bg3);
  border: 1px dashed var(--border);
  border-radius: var(--radius-sm);
  color: var(--accent);
  font-size: 15px;
  font-weight: 600;
  padding: 14px;
  cursor: pointer;
  transition: background .15s;
}
.btn-add-drink:active { background: var(--bg); }

.danger-zone .settings-title { color: var(--red); }
.btn-danger {
  width: 100%;
  background: none;
  border: 1px solid var(--red);
  border-radius: var(--radius-sm);
  color: var(--red);
  font-size: 15px;
  font-weight: 600;
  padding: 14px;
  cursor: pointer;
  transition: background .15s;
}
.btn-danger:active { background: rgba(255,95,87,.1); }

/* â”€â”€ MODALS â”€â”€ */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  z-index: 200;
  align-items: flex-end;
  justify-content: center;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.modal-overlay.open {
  display: flex;
  animation: fade-in .2s ease;
}
@keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }

.modal {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 24px 24px 0 0;
  padding: 24px 20px calc(24px + var(--safe-bottom));
  width: 100%;
  max-width: 480px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  animation: slide-up .25s cubic-bezier(.16,1,.3,1);
  max-height: 85dvh;
  overflow-y: auto;
}
@keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }

.modal-title {
  font-size: 20px;
  font-weight: 800;
  text-align: center;
  margin-bottom: 4px;
}
.modal-input {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 17px;
  padding: 14px 16px;
  outline: none;
  -webkit-appearance: none;
}
.modal-input:focus { border-color: var(--accent); }
.modal-input::placeholder { color: var(--text-muted); }

.btn-primary {
  width: 100%;
  background: var(--accent);
  border: none;
  border-radius: var(--radius-sm);
  color: #000;
  font-size: 17px;
  font-weight: 800;
  padding: 16px;
  cursor: pointer;
  transition: opacity .15s, transform .1s;
}
.btn-primary:active { opacity: .85; transform: scale(.98); }

.btn-secondary {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 16px;
  font-weight: 600;
  padding: 14px;
  cursor: pointer;
  transition: background .15s;
}
.btn-secondary:active { background: var(--bg); }

.btn-ghost {
  width: 100%;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 15px;
  font-weight: 600;
  padding: 12px;
  cursor: pointer;
}

.person-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 40dvh;
  overflow-y: auto;
}

.drink-price-display {
  text-align: center;
  font-size: 22px;
  font-weight: 700;
  color: var(--text-muted);
}
.qty-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  padding: 8px 0;
}
.qty-btn {
  width: 56px; height: 56px;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 50%;
  color: var(--text);
  font-size: 28px;
  font-weight: 700;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: background .15s, transform .1s;
}
.qty-btn:active { background: var(--bg); transform: scale(.9); }
.qty-display {
  font-size: 40px;
  font-weight: 800;
  min-width: 60px;
  text-align: center;
}
.total-display {
  text-align: center;
  font-size: 16px;
  color: var(--text-muted);
}
.total-display strong { color: var(--accent); font-size: 20px; }

/* â”€â”€ TOAST â”€â”€ */
.toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-80px);
  background: var(--text);
  color: var(--bg);
  font-size: 14px;
  font-weight: 700;
  padding: 12px 24px;
  border-radius: 40px;
  z-index: 999;
  transition: transform .3s cubic-bezier(.16,1,.3,1);
  pointer-events: none;
  white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); }
::-webkit-scrollbar { width: 0; }

/* â”€â”€ APP HEADER â”€â”€ */
.app-header {
  font-size: 13px;
  font-weight: 800;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--accent);
  text-align: center;
  padding: 12px 0 4px;
  opacity: 0.7;
}

/* â”€â”€ AVATAR â”€â”€ */
.avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--border);
  flex-shrink: 0;
  background: var(--bg3);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  overflow: hidden;
}
.avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }

/* Person-btn with avatar */
.person-btn-inner {
  display: flex;
  align-items: center;
  gap: 14px;
  justify-content: center;
}
.person-btn-avatar {
  width: 40px; height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--accent);
  flex-shrink: 0;
}
.person-btn-avatar.placeholder { font-size: 22px; background: var(--bg3); display:flex; align-items:center; justify-content:center; }

/* Person list btn with avatar */
.person-list-btn {
  width: 100%;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text);
  font-size: 17px;
  font-weight: 600;
  padding: 12px 16px;
  text-align: left;
  cursor: pointer;
  transition: border-color .15s, background .15s;
  display: flex;
  align-items: center;
  gap: 12px;
}
.person-list-btn.selected { border-color: var(--accent); color: var(--accent); }
.person-list-btn:active { background: var(--bg2); }
.person-list-avatar {
  width: 40px; height: 40px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
  background: var(--bg2);
  border: 1.5px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  overflow: hidden;
}
.person-list-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }

/* History item with avatar */
.history-item {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 12px 14px;
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 10px;
  align-items: center;
}
.history-avatar {
  width: 34px; height: 34px;
  border-radius: 50%;
  flex-shrink: 0;
  background: var(--bg3);
  border: 1.5px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  overflow: hidden;
}
.history-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }

/* Settings item with avatar */
.settings-person-avatar {
  width: 38px; height: 38px;
  border-radius: 50%;
  flex-shrink: 0;
  background: var(--bg2);
  border: 1.5px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  overflow: hidden;
  cursor: pointer;
  position: relative;
  transition: border-color .2s;
}
.settings-person-avatar:hover { border-color: var(--accent); }
.settings-person-avatar img { width:100%; height:100%; object-fit:cover; border-radius:50%; }
.settings-person-avatar .cam-overlay {
  position: absolute; inset:0; background: rgba(0,0,0,.45);
  display: flex; align-items:center; justify-content:center;
  border-radius: 50%; opacity: 0; transition: opacity .2s;
  font-size: 14px;
}
.settings-person-avatar:hover .cam-overlay,
.settings-person-avatar:active .cam-overlay { opacity: 1; }

  text-transform: uppercase;
  color: var(--accent);
  text-align: center;
  padding: 12px 0 4px;
  opacity: 0.7;
}
</style>
</head>
<body>

<!-- TOAST -->
<div id="toast" class="toast" aria-live="polite"></div>

<!-- APP SHELL -->
<div id="app">

  <!-- TAB BAR -->
  <nav class="tabbar">
    <button class="tab active" data-tab="home" onclick="switchTab('home')">
      <span class="tab-icon">ğŸ </span>
      <span class="tab-label">Kassa</span>
    </button>
    <button class="tab" data-tab="history" onclick="switchTab('history')">
      <span class="tab-icon">ğŸ“‹</span>
      <span class="tab-label">Verlauf</span>
    </button>
    <button class="tab" data-tab="settings" onclick="switchTab('settings')">
      <span class="tab-icon">âš™ï¸</span>
      <span class="tab-label">Einstellungen</span>
    </button>
  </nav>

  <!-- HOME TAB -->
  <main id="tab-home" class="tab-content active">
    <div class="app-header">ğŸº Kellerbar Kassa</div>
    <section class="balance-card">
      <div class="balance-label">Aktueller Stand</div>
      <div class="balance-amount" id="balance-total">â‚¬ 0,00</div>
      <div class="balance-sub">
        <span class="income-sum">â†‘ <span id="total-income">0,00</span></span>
        <span class="expense-sum">â†“ <span id="total-expense">0,00</span></span>
      </div>
    </section>

    <div class="section-label">Person</div>
    <button class="person-btn" id="person-btn">
      <span id="person-btn-text">ğŸ‘¤ Person wÃ¤hlen</span>
    </button>

    <div class="section-label">GetrÃ¤nke buchen</div>
    <div class="drinks-grid" id="drinks-grid"></div>

    <div class="action-row">
      <button class="btn-expense" onclick="openModal('modal-expense')">â– Ausgabe</button>
      <button class="btn-undo" onclick="undoLast()">â†© Undo</button>
    </div>
  </main>

  <!-- HISTORY TAB -->
  <main id="tab-history" class="tab-content">
    <div class="history-filters">
      <div class="filter-row">
        <button class="filter-btn active" onclick="setFilter('type','all',this)">Alle</button>
        <button class="filter-btn" onclick="setFilter('type','income',this)">Einnahmen</button>
        <button class="filter-btn" onclick="setFilter('type','expense',this)">Ausgaben</button>
      </div>
      <div class="filter-row">
        <select id="filter-person" class="filter-select" onchange="renderHistory()">
          <option value="all">Alle Personen</option>
        </select>
        <input type="search" id="filter-search" class="filter-input" placeholder="ğŸ” Sucheâ€¦" oninput="renderHistory()" />
      </div>
    </div>
    <div id="history-list" class="history-list"></div>
  </main>

  <!-- SETTINGS TAB -->
  <main id="tab-settings" class="tab-content">
    <div class="settings-section">
      <div class="settings-title">GetrÃ¤nke verwalten</div>
      <div id="drinks-settings-list" class="drinks-settings-list"></div>
      <button class="btn-add-drink" id="btn-add-drink-settings">ï¼‹ Neues GetrÃ¤nk</button>
    </div>
    <div class="settings-section">
      <div class="settings-title">Personen verwalten</div>
      <div id="persons-settings-list" class="persons-settings-list"></div>
      <div style="font-size:12px;color:var(--text-muted);text-align:center;padding: 0 0 4px">Auf das Foto-Symbol tippen um ein Bild aufzunehmen ğŸ“·</div>
    </div>
    <div class="settings-section danger-zone">
      <div class="settings-title">Gefahrenzone</div>
      <button class="btn-danger" onclick="resetConfirm()">ğŸ—‘ Alles zurÃ¼cksetzen</button>
    </div>
    <div class="settings-section">
      <div class="settings-title">Design</div>
      <button class="btn-secondary" onclick="openModal('modal-theme')" style="font-size:15px;padding:14px">ğŸ¨ Design Ã¤ndern</button>
    </div>
  </main>

</div>

<!-- MODALS -->

<!-- Person Select -->
<div id="modal-person-select" class="modal-overlay" onclick="closeModalOnBg(event,'modal-person-select')">
  <div class="modal">
    <div class="modal-title">Person wÃ¤hlen</div>
    <div id="person-list" class="person-list"></div>
    <button class="btn-secondary" onclick="openModal('modal-add-person')">ï¼‹ Neue Person</button>
    <button class="btn-ghost" onclick="closeModal('modal-person-select')">Abbrechen</button>
  </div>
</div>

<!-- Add Person -->
<div id="modal-add-person" class="modal-overlay" onclick="closeModalOnBg(event,'modal-add-person')">
  <div class="modal">
    <div class="modal-title">Neue Person</div>
    <input type="text" id="input-new-person" class="modal-input" placeholder="Name" maxlength="40" />
    <button class="btn-primary" onclick="addPerson()">HinzufÃ¼gen</button>
    <button class="btn-ghost" onclick="closeModal('modal-add-person')">Abbrechen</button>
  </div>
</div>

<!-- Drink Booking -->
<div id="modal-drink" class="modal-overlay" onclick="closeModalOnBg(event,'modal-drink')">
  <div class="modal">
    <div class="modal-title" id="drink-modal-name">GetrÃ¤nk</div>
    <div class="drink-price-display" id="drink-modal-price">â‚¬ 0,00</div>
    <div class="qty-row">
      <button class="qty-btn" onclick="changeQty(-1)">âˆ’</button>
      <span class="qty-display" id="qty-display">1</span>
      <button class="qty-btn" onclick="changeQty(+1)">ï¼‹</button>
    </div>
    <div class="total-display">Gesamt: <strong id="drink-modal-total">â‚¬ 0,00</strong></div>
    <button class="btn-primary" onclick="bookDrink()">âœ“ Buchen</button>
    <button class="btn-ghost" onclick="closeModal('modal-drink')">Abbrechen</button>
  </div>
</div>

<!-- Expense -->
<div id="modal-expense" class="modal-overlay" onclick="closeModalOnBg(event,'modal-expense')">
  <div class="modal">
    <div class="modal-title">Ausgabe</div>
    <input type="number" id="input-expense-amount" class="modal-input" placeholder="Betrag in â‚¬ (z.B. 12.50)" min="0.01" step="0.01" />
    <input type="text" id="input-expense-note" class="modal-input" placeholder="Notiz (optional)" maxlength="80" />
    <button class="btn-primary" onclick="addExpense()">Speichern</button>
    <button class="btn-ghost" onclick="closeModal('modal-expense')">Abbrechen</button>
  </div>
</div>

<!-- Add / Edit Drink -->
<div id="modal-add-drink" class="modal-overlay" onclick="closeModalOnBg(event,'modal-add-drink')">
  <div class="modal">
    <div class="modal-title" id="modal-add-drink-title">Neues GetrÃ¤nk</div>
    <input type="text" id="input-drink-name" class="modal-input" placeholder="Name" maxlength="40" />
    <input type="number" id="input-drink-price" class="modal-input" placeholder="Preis in â‚¬ (z.B. 2.50)" min="0" step="0.10" />
    <button class="btn-primary" onclick="saveDrink()">Speichern</button>
    <button class="btn-ghost" onclick="closeModal('modal-add-drink')">Abbrechen</button>
  </div>
</div>

<!-- Rename Person -->
<div id="modal-rename-person" class="modal-overlay" onclick="closeModalOnBg(event,'modal-rename-person')">
  <div class="modal">
    <div class="modal-title">Person umbenennen</div>
    <input type="text" id="input-rename-person" class="modal-input" placeholder="Neuer Name" maxlength="40" />
    <button class="btn-primary" onclick="renamePerson()">Speichern</button>
    <button class="btn-ghost" onclick="closeModal('modal-rename-person')">Abbrechen</button>
  </div>
</div>

<!-- Confirm Dialog (ersetzt confirm() fÃ¼r iOS PWA) -->
<div id="modal-confirm" class="modal-overlay">
  <div class="modal">
    <div class="modal-title" id="confirm-title">Sicher?</div>
    <div id="confirm-msg" style="text-align:center;color:var(--text-muted);font-size:15px;line-height:1.5"></div>
    <button class="btn-danger" id="confirm-ok-btn">Ja, lÃ¶schen</button>
    <button class="btn-ghost" id="confirm-cancel-btn">Abbrechen</button>
  </div>
</div>

<!-- Hidden file input for photo capture -->
<input type="file" id="photo-input" accept="image/*" style="display:none" />

<!-- Photo preview / crop modal -->
<div id="modal-photo" class="modal-overlay">
  <div class="modal" style="align-items:center">
    <div class="modal-title">Profilbild</div>
    <canvas id="photo-canvas" style="display:none"></canvas>
    <img id="photo-preview" src="" alt="" style="width:160px;height:160px;border-radius:50%;object-fit:cover;border:3px solid var(--accent);margin:0 auto;display:block" />
    <button class="btn-primary" id="photo-save-btn">âœ“ Speichern</button>
    <button class="btn-secondary" id="photo-retake-btn">ğŸ“· Neu aufnehmen</button>
    <button class="btn-ghost" id="photo-cancel-btn">Abbrechen</button>
  </div>
</div>

<!-- Theme Picker -->
<div id="modal-theme" class="modal-overlay" onclick="closeModalOnBg(event,'modal-theme')">
  <div class="modal">
    <div class="modal-title">ğŸ¨ Design wÃ¤hlen</div>
    <div class="theme-grid" id="theme-grid"></div>
    <div style="margin-top:4px;font-size:11px;text-align:center;color:var(--text-muted);letter-spacing:.5px;text-transform:uppercase;font-weight:700">oder eigenes Design</div>
    <button class="btn-secondary" id="btn-open-custom-picker" style="display:flex;align-items:center;justify-content:center;gap:10px;font-size:15px">
      <span id="custom-preview-dots" style="display:flex;gap:5px"></span>
      <span>ğŸ¨ Eigene Farben</span>
    </button>
    <button class="btn-ghost" onclick="closeModal('modal-theme')">SchlieÃŸen</button>
  </div>
</div>

<!-- Custom Color Picker -->
<div id="modal-custom-theme" class="modal-overlay" onclick="closeModalOnBg(event,'modal-custom-theme')">
  <div class="modal">
    <div class="modal-title">ğŸ¨ Eigene Farben</div>

    <div class="custom-picker-row">
      <div class="custom-picker-label">
        Hintergrund
        <small>Hauptfarbe der App</small>
      </div>
      <div class="color-input-wrap">
        <input type="color" id="cp-bg" value="#0a0a0f" oninput="previewCustom()" />
        <div class="color-swatch-display" id="cp-bg-swatch" style="background:#0a0a0f"></div>
      </div>
    </div>

    <div class="custom-picker-row">
      <div class="custom-picker-label">
        Akzentfarbe
        <small>Buttons, Preise, Highlights</small>
      </div>
      <div class="color-input-wrap">
        <input type="color" id="cp-accent" value="#f5c842" oninput="previewCustom()" />
        <div class="color-swatch-display" id="cp-accent-swatch" style="background:#f5c842"></div>
      </div>
    </div>

    <div class="custom-picker-row">
      <div class="custom-picker-label">
        Kartenfarbe
        <small>Hintergrund der Karten</small>
      </div>
      <div class="color-input-wrap">
        <input type="color" id="cp-card" value="#13131c" oninput="previewCustom()" />
        <div class="color-swatch-display" id="cp-card-swatch" style="background:#13131c"></div>
      </div>
    </div>

    <div class="custom-picker-row">
      <div class="custom-picker-label">
        Textfarbe
        <small>Haupttext</small>
      </div>
      <div class="color-input-wrap">
        <input type="color" id="cp-text" value="#f0f0f5" oninput="previewCustom()" />
        <div class="color-swatch-display" id="cp-text-swatch" style="background:#f0f0f5"></div>
      </div>
    </div>

    <button class="btn-primary" onclick="saveCustomTheme()">âœ“ Ãœbernehmen</button>
    <button class="btn-ghost" onclick="closeModal('modal-custom-theme')">Abbrechen</button>
  </div>
</div>

<script>
'use strict';

/* â”€â”€ DATA VERSION & DEFAULTS â”€â”€ */
const DATA_VERSION = 'kk_v1';

function uid() {
  return Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
}

const DEFAULT_DRINKS = [
  { id: uid(), name: 'Bier',        price: 2.00 },
  { id: uid(), name: 'Spritzer',    price: 2.00 },
  { id: uid(), name: 'Gin Tonic',   price: 3.00 },
  { id: uid(), name: 'Alkoholfrei', price: 1.00 },
];

/* â”€â”€ STATE â”€â”€ */
let state = { version: DATA_VERSION, drinks: [], persons: [], bookings: [] };

let currentPerson  = null;
let currentDrink   = null;
let currentQty     = 1;
let editingDrinkId = null;
let editPersonId   = null;
let filterType     = 'all';

/* â”€â”€ UTILITIES â”€â”€ */
function fmt(amount) {
  return 'â‚¬ ' + Math.abs(amount).toFixed(2).replace('.', ',');
}
function fmtSigned(amount) {
  return (amount >= 0 ? '+' : 'âˆ’') + ' ' + fmt(amount);
}
function fmtDate(ts) {
  const d = new Date(ts);
  return String(d.getDate()).padStart(2,'0') + '.' +
         String(d.getMonth()+1).padStart(2,'0') + '. ' +
         String(d.getHours()).padStart(2,'0') + ':' +
         String(d.getMinutes()).padStart(2,'0');
}
function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* â”€â”€ STORAGE â”€â”€ */
function loadState() {
  try {
    const raw = localStorage.getItem(DATA_VERSION);
    if (raw) {
      state = JSON.parse(raw);
      state.drinks   = state.drinks   || [];
      state.persons  = state.persons  || [];
      state.bookings = state.bookings || [];
    } else {
      state.drinks = DEFAULT_DRINKS.map(d => ({ ...d }));
    }
  } catch(e) { console.error('loadState', e); }
}
function saveState() {
  try { localStorage.setItem(DATA_VERSION, JSON.stringify(state)); } catch(e) {}
}

/* â”€â”€ MODAL HELPERS â”€â”€ */
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function closeModalOnBg(e, id) { if (e.target.id === id) closeModal(id); }

/* â”€â”€ TOAST â”€â”€ */
let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  if (toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 1800);
}

/* â”€â”€ TAB SWITCHING â”€â”€ */
function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
  if (tab === 'history')  renderHistory();
  if (tab === 'settings') { renderSettings(); renderThemeGrid(); }
}

/* â”€â”€ THEME SYSTEM â”€â”€ */
const THEMES = [
  {
    id: 'default',
    name: 'Keller',
    gradient: 'linear-gradient(145deg, #13131c 0%, #0a0a0f 100%)',
    dots: ['#f5c842', '#3ddc84', '#ff5f57'],
  },
  {
    id: 'light',
    name: 'Hell',
    gradient: 'linear-gradient(145deg, #ffffff 0%, #e8e8f0 100%)',
    dots: ['#3b82f6', '#16a34a', '#dc2626'],
  },
];

let currentTheme = localStorage.getItem('kk_theme') || 'default';

/* Custom theme colors stored separately */
let customColors = JSON.parse(localStorage.getItem('kk_custom_colors') || 'null') || {
  bg: '#0a0a0f', accent: '#f5c842', card: '#13131c', text: '#f0f0f5'
};

function applyTheme(id) {
  currentTheme = id;
  document.body.dataset.theme = id === 'default' ? '' : id;
  localStorage.setItem('kk_theme', id);
  if (id === 'custom') applyCustomVars(customColors);
  renderThemeGrid();
  updateCustomPreviewDots();
}

function applyCustomVars(c) {
  const r = document.documentElement.style;
  // derive darker shades from bg
  const bg2 = lightenDarken(c.bg, 10);
  const bg3 = lightenDarken(c.bg, 20);
  const border = lightenDarken(c.bg, 35);
  const muted = blendColors(c.text, c.bg, 0.45);
  const shadow = hexToRgba(c.accent, 0.18);
  const glow   = hexToRgba(c.accent, 0.25);
  const btnText = luminance(c.accent) > 0.4 ? '#000' : '#fff';

  r.setProperty('--custom-bg',       c.bg);
  r.setProperty('--custom-bg2',      bg2);
  r.setProperty('--custom-bg3',      bg3);
  r.setProperty('--custom-border',   border);
  r.setProperty('--custom-accent',   c.accent);
  r.setProperty('--custom-text',     c.text);
  r.setProperty('--custom-muted',    muted);
  r.setProperty('--custom-card-bg',  c.card);
  r.setProperty('--custom-shadow',   `0 4px 24px ${shadow}`);
  r.setProperty('--custom-glow',     `0 0 20px ${glow}`);
  r.setProperty('--custom-body-bg',  c.bg);
  r.setProperty('--custom-btn-text', btnText);
}

/* Color math helpers */
function hexToRgb(hex) {
  const r = parseInt(hex.slice(1,3),16);
  const g = parseInt(hex.slice(3,5),16);
  const b = parseInt(hex.slice(5,7),16);
  return {r,g,b};
}
function hexToRgba(hex, a) {
  const {r,g,b} = hexToRgb(hex);
  return `rgba(${r},${g},${b},${a})`;
}
function rgbToHex(r,g,b) {
  return '#' + [r,g,b].map(v => Math.max(0,Math.min(255,Math.round(v))).toString(16).padStart(2,'0')).join('');
}
function lightenDarken(hex, amt) {
  const {r,g,b} = hexToRgb(hex);
  const lum = luminance(hex);
  const d = lum < 0.15 ? amt : -amt; // dark bg â†’ lighten; light bg â†’ darken
  return rgbToHex(r+d, g+d, b+d);
}
function blendColors(hex1, hex2, t) {
  const a = hexToRgb(hex1), b2 = hexToRgb(hex2);
  return rgbToHex(
    a.r * t + b2.r * (1-t),
    a.g * t + b2.g * (1-t),
    a.b * t + b2.b * (1-t)
  );
}
function luminance(hex) {
  const {r,g,b} = hexToRgb(hex);
  return (0.299*r + 0.587*g + 0.114*b) / 255;
}

function renderThemeGrid() {
  const grid = document.getElementById('theme-grid');
  if (!grid) return;
  grid.innerHTML = '';
  THEMES.forEach(t => {
    const btn = document.createElement('button');
    btn.className = 'theme-btn' + (currentTheme === t.id ? ' active-theme' : '');
    btn.style.background = t.gradient;

    const dots = document.createElement('div');
    dots.className = 'theme-dots';
    t.dots.forEach(color => {
      const dot = document.createElement('div');
      dot.className = 'theme-dot';
      dot.style.background = color;
      dot.style.boxShadow = `0 0 6px ${color}88`;
      dots.appendChild(dot);
    });

    const name = document.createElement('div');
    name.className = 'theme-name';
    name.textContent = t.name;

    btn.appendChild(dots);
    btn.appendChild(name);
    btn.addEventListener('click', () => {
      applyTheme(t.id);
      showToast('ğŸ¨ ' + t.name);
    });
    grid.appendChild(btn);
  });
  updateCustomPreviewDots();
}

function updateCustomPreviewDots() {
  const wrap = document.getElementById('custom-preview-dots');
  if (!wrap) return;
  wrap.innerHTML = '';
  [customColors.bg, customColors.accent, customColors.card, customColors.text].forEach(c => {
    const d = document.createElement('div');
    d.style.cssText = `width:12px;height:12px;border-radius:50%;background:${c};border:1.5px solid rgba(255,255,255,.3);box-shadow:0 0 5px ${c}99`;
    wrap.appendChild(d);
  });
  // Highlight button if custom is active
  const customBtn = document.getElementById('btn-open-custom-picker');
  if (customBtn) {
    customBtn.style.borderColor = currentTheme === 'custom' ? 'var(--accent)' : '';
  }
}

function openCustomPicker() {
  // Load saved custom colors into inputs
  document.getElementById('cp-bg').value     = customColors.bg;
  document.getElementById('cp-accent').value = customColors.accent;
  document.getElementById('cp-card').value   = customColors.card;
  document.getElementById('cp-text').value   = customColors.text;
  updateSwatches();
  closeModal('modal-theme');
  openModal('modal-custom-theme');
}

function updateSwatches() {
  ['bg','accent','card','text'].forEach(key => {
    const val = document.getElementById(`cp-${key}`).value;
    document.getElementById(`cp-${key}-swatch`).style.background = val;
  });
}

function previewCustom() {
  updateSwatches();
  // Live preview if already in custom mode
  if (currentTheme === 'custom') {
    const c = getPickerValues();
    applyCustomVars(c);
  }
}

function getPickerValues() {
  return {
    bg:     document.getElementById('cp-bg').value,
    accent: document.getElementById('cp-accent').value,
    card:   document.getElementById('cp-card').value,
    text:   document.getElementById('cp-text').value,
  };
}

function saveCustomTheme() {
  customColors = getPickerValues();
  localStorage.setItem('kk_custom_colors', JSON.stringify(customColors));
  applyTheme('custom');
  closeModal('modal-custom-theme');
  showToast('ğŸ¨ Eigenes Design gespeichert');
}


/* â”€â”€ PERSON MANAGEMENT â”€â”€ */
function renderPersonBtn() {
  const btn = document.getElementById('person-btn');
  if (currentPerson) {
    const p = state.persons.find(x => x.id === currentPerson.id);
    const photo = p?.photo || null;
    btn.innerHTML = `<div class="person-btn-inner">
      ${photo
        ? `<img class="person-btn-avatar" src="${photo}" alt="" />`
        : `<div class="person-btn-avatar placeholder">ğŸ‘¤</div>`}
      <span>${escHtml(currentPerson.name)}</span>
    </div>`;
  } else {
    btn.innerHTML = `<span id="person-btn-text">ğŸ‘¤ Person wÃ¤hlen</span>`;
  }
}

function renderPersonListModal() {
  const list = document.getElementById('person-list');
  list.innerHTML = '';
  if (state.persons.length === 0) {
    list.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:16px">Noch keine Personen.</div>';
    return;
  }
  state.persons.forEach(p => {
    const btn = document.createElement('button');
    btn.className = 'person-list-btn' + (currentPerson?.id === p.id ? ' selected' : '');

    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'person-list-avatar';
    if (p.photo) {
      const img = document.createElement('img');
      img.src = p.photo;
      avatarDiv.appendChild(img);
    } else {
      avatarDiv.textContent = 'ğŸ‘¤';
    }

    const nameSpan = document.createElement('span');
    nameSpan.textContent = p.name;

    btn.appendChild(avatarDiv);
    btn.appendChild(nameSpan);
    btn.onclick = () => {
      currentPerson = { id: p.id, name: p.name };
      renderPersonBtn();
      closeModal('modal-person-select');
      showToast('ğŸ‘¤ ' + p.name);
    };
    list.appendChild(btn);
  });
}

function addPerson() {
  const input = document.getElementById('input-new-person');
  const name = input.value.trim();
  if (!name) { showToast('âš ï¸ Name eingeben'); return; }
  if (state.persons.find(p => p.name.toLowerCase() === name.toLowerCase())) {
    showToast('âš ï¸ Name bereits vorhanden'); return;
  }
  const person = { id: uid(), name };
  state.persons.push(person);
  saveState();
  input.value = '';
  currentPerson = { id: person.id, name: person.name };
  renderPersonBtn();
  closeModal('modal-add-person');
  renderPersonListModal();
  openModal('modal-person-select');
  showToast('âœ“ ' + name + ' hinzugefÃ¼gt');
}

/* â”€â”€ DRINKS â”€â”€ */
function renderDrinksGrid() {
  const grid = document.getElementById('drinks-grid');
  grid.innerHTML = '';
  state.drinks.forEach(drink => {
    const btn = document.createElement('button');
    btn.className = 'drink-btn';
    btn.innerHTML = `<span class="drink-btn-name">${escHtml(drink.name)}</span>
                     <span class="drink-btn-price">${fmt(drink.price)}</span>`;
    btn.onclick = () => openDrinkModal(drink);
    grid.appendChild(btn);
  });
}

function openDrinkModal(drink) {
  if (!currentPerson) {
    showToast('âš ï¸ Zuerst Person wÃ¤hlen!');
    renderPersonListModal();
    openModal('modal-person-select');
    return;
  }
  currentDrink = { id: drink.id, name: drink.name, price: drink.price };
  currentQty = 1;
  document.getElementById('drink-modal-name').textContent  = drink.name;
  document.getElementById('drink-modal-price').textContent = fmt(drink.price);
  updateDrinkModalTotal();
  openModal('modal-drink');
}

function changeQty(delta) {
  currentQty = Math.max(1, currentQty + delta);
  updateDrinkModalTotal();
}

function updateDrinkModalTotal() {
  document.getElementById('qty-display').textContent = currentQty;
  const total = currentDrink ? currentDrink.price * currentQty : 0;
  document.getElementById('drink-modal-total').textContent = fmt(total);
}

function bookDrink() {
  if (!currentDrink || !currentPerson) return;
  state.bookings.unshift({
    id: uid(), timestamp: Date.now(),
    person_id: currentPerson.id, person_name: currentPerson.name,
    type: 'income',
    item_name: currentDrink.name, qty: currentQty, unit_price: currentDrink.price,
    amount_total: +(currentDrink.price * currentQty).toFixed(2),
  });
  saveState();
  closeModal('modal-drink');
  renderDrinksGrid();
  updateBalance();
  showToast(`âœ“ ${currentDrink.name} Ã— ${currentQty} gebucht`);
}

/* â”€â”€ EXPENSES â”€â”€ */
function addExpense() {
  if (!currentPerson) {
    showToast('âš ï¸ Zuerst Person wÃ¤hlen!');
    closeModal('modal-expense');
    renderPersonListModal();
    openModal('modal-person-select');
    return;
  }
  const amtRaw = parseFloat(document.getElementById('input-expense-amount').value.replace(',', '.'));
  if (!amtRaw || amtRaw <= 0 || isNaN(amtRaw)) { showToast('âš ï¸ GÃ¼ltigen Betrag eingeben'); return; }
  const note = document.getElementById('input-expense-note').value.trim();
  state.bookings.unshift({
    id: uid(), timestamp: Date.now(),
    person_id: currentPerson.id, person_name: currentPerson.name,
    type: 'expense', note: note || '',
    amount_total: -(+amtRaw.toFixed(2)),
  });
  saveState();
  document.getElementById('input-expense-amount').value = '';
  document.getElementById('input-expense-note').value   = '';
  closeModal('modal-expense');
  updateBalance();
  showToast('âœ“ Ausgabe gespeichert');
}

/* â”€â”€ BALANCE â”€â”€ */
function updateBalance() {
  const income  = state.bookings.filter(b => b.type === 'income').reduce((s,b) => s + b.amount_total, 0);
  const expense = state.bookings.filter(b => b.type === 'expense').reduce((s,b) => s + b.amount_total, 0);
  const total   = income + expense;
  const el = document.getElementById('balance-total');
  el.textContent   = fmt(total);
  el.style.color   = total < 0 ? 'var(--red)' : 'var(--accent)';
  document.getElementById('total-income').textContent  = income.toFixed(2).replace('.', ',');
  document.getElementById('total-expense').textContent = Math.abs(expense).toFixed(2).replace('.', ',');
}

/* â”€â”€ UNDO â”€â”€ */
function undoLast() {
  if (state.bookings.length === 0) { showToast('Kein Eintrag zum RÃ¼ckgÃ¤ngigmachen'); return; }
  const last = state.bookings.shift();
  saveState();
  updateBalance();
  showToast(last.type === 'income'
    ? `â†© ${last.item_name} Ã— ${last.qty} rÃ¼ckgÃ¤ngig`
    : `â†© Ausgabe rÃ¼ckgÃ¤ngig`);
}

/* â”€â”€ HISTORY â”€â”€ */
function setFilter(category, value, btn) {
  filterType = value;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderHistory();
}

function renderHistory() {
  updatePersonFilterSelect();
  const personFilter = document.getElementById('filter-person')?.value || 'all';
  const searchQuery  = (document.getElementById('filter-search')?.value || '').toLowerCase().trim();
  const list = document.getElementById('history-list');
  list.innerHTML = '';
  let items = [...state.bookings];
  if (filterType !== 'all')   items = items.filter(b => b.type === filterType);
  if (personFilter !== 'all') items = items.filter(b => b.person_id === personFilter);
  if (searchQuery) {
    items = items.filter(b =>
      (b.item_name || '').toLowerCase().includes(searchQuery) ||
      (b.note      || '').toLowerCase().includes(searchQuery)
    );
  }
  if (items.length === 0) {
    list.innerHTML = '<div class="history-empty">Keine EintrÃ¤ge gefunden.</div>';
    return;
  }
  items.forEach(b => {
    const div = document.createElement('div');
    div.className = 'history-item';

    // Avatar
    const p = state.persons.find(x => x.id === b.person_id);
    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'history-avatar';
    if (p?.photo) {
      const img = document.createElement('img');
      img.src = p.photo;
      avatarDiv.appendChild(img);
    } else {
      avatarDiv.textContent = 'ğŸ‘¤';
    }

    const desc = b.type === 'income'
      ? `${escHtml(b.item_name)} Ã— ${b.qty}`
      : `Ausgabe${b.note ? ': ' + escHtml(b.note) : ''}`;

    const infoDiv = document.createElement('div');
    infoDiv.innerHTML = `<div class="history-item-desc">${desc}</div>
      <div class="history-item-meta">${fmtDate(b.timestamp)} Â· ${escHtml(b.person_name)}</div>`;

    const amtDiv = document.createElement('div');
    amtDiv.className = 'history-item-amount ' + (b.amount_total >= 0 ? 'pos' : 'neg');
    amtDiv.textContent = fmtSigned(b.amount_total);

    div.appendChild(avatarDiv);
    div.appendChild(infoDiv);
    div.appendChild(amtDiv);
    list.appendChild(div);
  });
}

function updatePersonFilterSelect() {
  const sel = document.getElementById('filter-person');
  if (!sel) return;
  const current = sel.value;
  sel.innerHTML = '<option value="all">Alle Personen</option>';
  state.persons.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id; opt.textContent = p.name;
    if (p.id === current) opt.selected = true;
    sel.appendChild(opt);
  });
  [...new Set(state.bookings.map(b => b.person_id))].forEach(pid => {
    if (!state.persons.find(p => p.id === pid)) {
      const name = state.bookings.find(b => b.person_id === pid)?.person_name || pid;
      const opt = document.createElement('option');
      opt.value = pid; opt.textContent = name + ' (gelÃ¶scht)';
      if (pid === current) opt.selected = true;
      sel.appendChild(opt);
    }
  });
}

/* â”€â”€ SETTINGS â€“ DRINKS â”€â”€ */
function openModal_AddDrink() {
  editingDrinkId = null;
  document.getElementById('modal-add-drink-title').textContent = 'Neues GetrÃ¤nk';
  document.getElementById('input-drink-name').value  = '';
  document.getElementById('input-drink-price').value = '';
  openModal('modal-add-drink');
}

function openModal_EditDrink(drinkId) {
  editingDrinkId = drinkId;
  const drink = state.drinks.find(d => d.id === drinkId);
  if (!drink) return;
  document.getElementById('modal-add-drink-title').textContent = 'GetrÃ¤nk bearbeiten';
  document.getElementById('input-drink-name').value  = drink.name;
  document.getElementById('input-drink-price').value = drink.price.toFixed(2);
  openModal('modal-add-drink');
}

function saveDrink() {
  const name  = document.getElementById('input-drink-name').value.trim();
  const price = parseFloat(document.getElementById('input-drink-price').value.replace(',', '.'));
  if (!name)                   { showToast('âš ï¸ Name eingeben'); return; }
  if (isNaN(price) || price < 0) { showToast('âš ï¸ GÃ¼ltigen Preis eingeben'); return; }
  if (editingDrinkId) {
    const idx = state.drinks.findIndex(d => d.id === editingDrinkId);
    if (idx !== -1) { state.drinks[idx].name = name; state.drinks[idx].price = +price.toFixed(2); }
    showToast('âœ“ GetrÃ¤nk aktualisiert');
  } else {
    state.drinks.push({ id: uid(), name, price: +price.toFixed(2) });
    showToast('âœ“ GetrÃ¤nk hinzugefÃ¼gt');
  }
  saveState();
  closeModal('modal-add-drink');
  renderDrinksGrid();
  renderSettings();
}

/* â”€â”€ CONFIRM MODAL (iOS PWA-safe, kein confirm()) â”€â”€ */
function showConfirm(title, msg, okLabel, onOk) {
  document.getElementById('confirm-title').textContent = title;
  document.getElementById('confirm-msg').textContent   = msg;
  document.getElementById('confirm-ok-btn').textContent = okLabel || 'Ja, lÃ¶schen';
  openModal('modal-confirm');
  // Einmalige Listener â€” nach Klick sofort entfernen
  const okBtn     = document.getElementById('confirm-ok-btn');
  const cancelBtn = document.getElementById('confirm-cancel-btn');
  function doOk() {
    cleanup();
    closeModal('modal-confirm');
    onOk();
  }
  function doCancel() {
    cleanup();
    closeModal('modal-confirm');
  }
  function cleanup() {
    okBtn.removeEventListener('click', doOk);
    cancelBtn.removeEventListener('click', doCancel);
  }
  okBtn.addEventListener('click', doOk);
  cancelBtn.addEventListener('click', doCancel);
}

function deleteDrink(drinkId) {
  const drink = state.drinks.find(d => d.id === drinkId);
  if (!drink) return;
  showConfirm(
    'ğŸ—‘ GetrÃ¤nk lÃ¶schen',
    `â€${drink.name}" wirklich lÃ¶schen? Alte Buchungen bleiben erhalten.`,
    'Ja, lÃ¶schen',
    () => {
      state.drinks = state.drinks.filter(d => d.id !== drinkId);
      saveState();
      renderDrinksGrid();
      renderSettings();
      showToast('ğŸ—‘ GetrÃ¤nk gelÃ¶scht');
    }
  );
}

/* â”€â”€ SETTINGS â€“ PERSONS â”€â”€ */
function openModal_RenamePerson(personId) {
  editPersonId = personId;
  const p = state.persons.find(x => x.id === personId);
  if (!p) return;
  document.getElementById('input-rename-person').value = p.name;
  openModal('modal-rename-person');
}

function renamePerson() {
  const name = document.getElementById('input-rename-person').value.trim();
  if (!name) { showToast('âš ï¸ Name eingeben'); return; }
  const idx = state.persons.findIndex(p => p.id === editPersonId);
  if (idx === -1) return;
  state.persons[idx].name = name;
  if (currentPerson?.id === editPersonId) { currentPerson.name = name; renderPersonBtn(); }
  saveState();
  closeModal('modal-rename-person');
  renderSettings();
  showToast('âœ“ Umbenannt');
}

function deletePerson(personId) {
  const p = state.persons.find(x => x.id === personId);
  if (!p) return;
  showConfirm(
    'ğŸ—‘ Person lÃ¶schen',
    `â€${p.name}" wirklich lÃ¶schen? Buchungen bleiben erhalten.`,
    'Ja, lÃ¶schen',
    () => {
      state.persons = state.persons.filter(x => x.id !== personId);
      if (currentPerson?.id === personId) { currentPerson = null; renderPersonBtn(); }
      saveState();
      renderSettings();
      showToast('ğŸ—‘ Person gelÃ¶scht');
    }
  );
}

/* â”€â”€ SETTINGS RENDER â”€â”€ */
function renderSettings() {
  const dl = document.getElementById('drinks-settings-list');
  dl.innerHTML = '';
  state.drinks.forEach(drink => {
    const item = document.createElement('div');
    item.className = 'settings-item';

    const nameSpan = document.createElement('span');
    nameSpan.className = 'settings-item-name';
    nameSpan.textContent = drink.name;

    const priceSpan = document.createElement('span');
    priceSpan.className = 'settings-item-price';
    priceSpan.textContent = fmt(drink.price);

    const editBtn = document.createElement('button');
    editBtn.className = 'settings-item-btn';
    editBtn.title = 'Bearbeiten';
    editBtn.textContent = 'âœï¸';
    editBtn.addEventListener('click', () => openModal_EditDrink(drink.id));

    const delBtn = document.createElement('button');
    delBtn.className = 'settings-item-btn';
    delBtn.title = 'LÃ¶schen';
    delBtn.textContent = 'ğŸ—‘';
    delBtn.addEventListener('click', () => deleteDrink(drink.id));

    item.appendChild(nameSpan);
    item.appendChild(priceSpan);
    item.appendChild(editBtn);
    item.appendChild(delBtn);
    dl.appendChild(item);
  });

  const pl = document.getElementById('persons-settings-list');
  pl.innerHTML = '';
  if (state.persons.length === 0) {
    pl.innerHTML = '<div style="color:var(--text-muted);font-size:14px;text-align:center;padding:8px">Noch keine Personen</div>';
  }
  state.persons.forEach(p => {
    const item = document.createElement('div');
    item.className = 'settings-item';

    // Tappable avatar
    const avatarDiv = document.createElement('div');
    avatarDiv.className = 'settings-person-avatar';
    if (p.photo) {
      const img = document.createElement('img');
      img.src = p.photo;
      avatarDiv.appendChild(img);
    } else {
      avatarDiv.textContent = 'ğŸ‘¤';
    }
    const camOverlay = document.createElement('div');
    camOverlay.className = 'cam-overlay';
    camOverlay.textContent = 'ğŸ“·';
    avatarDiv.appendChild(camOverlay);
    avatarDiv.title = 'Foto aufnehmen';
    avatarDiv.addEventListener('click', () => triggerPhoto(p.id));

    const nameSpan = document.createElement('span');
    nameSpan.className = 'settings-item-name';
    nameSpan.textContent = p.name;

    const renameBtn = document.createElement('button');
    renameBtn.className = 'settings-item-btn';
    renameBtn.title = 'Umbenennen';
    renameBtn.textContent = 'âœï¸';
    renameBtn.addEventListener('click', () => openModal_RenamePerson(p.id));

    const delBtn = document.createElement('button');
    delBtn.className = 'settings-item-btn';
    delBtn.title = 'LÃ¶schen';
    delBtn.textContent = 'ğŸ—‘';
    delBtn.addEventListener('click', () => deletePerson(p.id));

    item.appendChild(avatarDiv);
    item.appendChild(nameSpan);
    item.appendChild(renameBtn);
    item.appendChild(delBtn);
    pl.appendChild(item);
  });
}

/* â”€â”€ RESET â”€â”€ */
function resetConfirm() {
  showConfirm(
    'âš ï¸ Alles zurÃ¼cksetzen?',
    'Alle Buchungen, Personen und GetrÃ¤nke werden unwiderruflich gelÃ¶scht.',
    'Ja, weiter',
    () => {
      showConfirm(
        'âš ï¸ Wirklich sicher?',
        'Das kann nicht rÃ¼ckgÃ¤ngig gemacht werden. Wirklich alles lÃ¶schen?',
        'âœ“ Ja, alles lÃ¶schen',
        () => {
          localStorage.removeItem(DATA_VERSION);
          state = { version: DATA_VERSION, drinks: DEFAULT_DRINKS.map(d => ({...d, id: uid()})), persons: [], bookings: [] };
          saveState();
          currentPerson = null;
          renderAll();
          showToast('ğŸ—‘ Alles zurÃ¼ckgesetzt');
        }
      );
    }
  );
}

/* â”€â”€ FOTO / PROFILBILD â”€â”€ */
let photoTargetPersonId = null;

function triggerPhoto(personId) {
  photoTargetPersonId = personId;
  document.getElementById('photo-input').value = '';
  document.getElementById('photo-input').click();
}

function handlePhotoSelected(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    const originalDataUrl = e.target.result;
    // Compress to max 220Ã—220 JPEG, quality 0.75 â†’ keeps size tiny
    const img = new Image();
    img.onload = () => {
      const SIZE = 220;
      const canvas = document.getElementById('photo-canvas');
      const ctx = canvas.getContext('2d');
      // Center-crop to square
      const side = Math.min(img.width, img.height);
      const sx = (img.width  - side) / 2;
      const sy = (img.height - side) / 2;
      canvas.width  = SIZE;
      canvas.height = SIZE;
      ctx.drawImage(img, sx, sy, side, side, 0, 0, SIZE, SIZE);
      const compressed = canvas.toDataURL('image/jpeg', 0.75);
      // Show preview
      document.getElementById('photo-preview').src = compressed;
      openModal('modal-photo');
    };
    img.src = originalDataUrl;
  };
  reader.readAsDataURL(file);
}

function savePhoto(dataUrl) {
  const idx = state.persons.findIndex(p => p.id === photoTargetPersonId);
  if (idx === -1) return;
  state.persons[idx].photo = dataUrl;
  saveState();
  // Update currentPerson display if that's who we edited
  if (currentPerson?.id === photoTargetPersonId) renderPersonBtn();
  renderSettings();
  closeModal('modal-photo');
  showToast('ğŸ“· Foto gespeichert');
}

/* â”€â”€ RENDER ALL â”€â”€ */
function renderAll() {
  renderPersonBtn();
  renderDrinksGrid();
  updateBalance();
  renderSettings();
}

/* â”€â”€ BOOT â”€â”€ */
(function init() {
  loadState();
  applyTheme(currentTheme);
  if (currentTheme === 'custom') applyCustomVars(customColors);
  renderAll();

  document.getElementById('person-btn').onclick = () => {
    renderPersonListModal();
    openModal('modal-person-select');
  };

  document.getElementById('btn-add-drink-settings').onclick = openModal_AddDrink;

  // Photo input
  const photoInput = document.getElementById('photo-input');
  photoInput.addEventListener('change', () => {
    if (photoInput.files && photoInput.files[0]) {
      handlePhotoSelected(photoInput.files[0]);
    }
  });
  document.getElementById('photo-save-btn').addEventListener('click', () => {
    const src = document.getElementById('photo-preview').src;
    if (src) savePhoto(src);
  });
  document.getElementById('photo-retake-btn').addEventListener('click', () => {
    closeModal('modal-photo');
    // small delay so modal closes before camera opens
    setTimeout(() => document.getElementById('photo-input').click(), 200);
  });
  document.getElementById('photo-cancel-btn').addEventListener('click', () => closeModal('modal-photo'));
  document.getElementById('btn-open-custom-picker').addEventListener('click', openCustomPicker);

  // Enter key shortcuts
  document.getElementById('input-new-person').addEventListener('keyup',      e => { if (e.key==='Enter') addPerson(); });
  document.getElementById('input-drink-name').addEventListener('keyup',      e => { if (e.key==='Enter') saveDrink(); });
  document.getElementById('input-drink-price').addEventListener('keyup',     e => { if (e.key==='Enter') saveDrink(); });
  document.getElementById('input-rename-person').addEventListener('keyup',   e => { if (e.key==='Enter') renamePerson(); });
  document.getElementById('input-expense-amount').addEventListener('keyup',  e => { if (e.key==='Enter') addExpense(); });
})();
</script>
</body>
</html>
